<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0">
		<style>
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#map {
			height: 100%;
			}
		</style>
		<title>whereis</title>
	</head>
	<body>
		<div id="map"></div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="http://momentjs.com/downloads/moment-with-locales.js"></script>
		<script src="http://momentjs.com/downloads/moment-timezone-with-data.js"></script>
		<script>
		      function InfoControl(controlDiv, map, last_updated, battery_level) {
				// Set CSS for the control border.
				var controlUI = document.createElement('div');
				controlUI.style.backgroundColor = '#fff';
				controlUI.style.border = '2px solid #fff';
				controlUI.style.borderRadius = '3px';
				controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
				controlUI.style.cursor = 'pointer';
				controlUI.style.marginBottom = '22px';
				controlUI.style.textAlign = 'center';
				controlDiv.appendChild(controlUI);

				// Set CSS for the control interior.
				var controlText = document.createElement('div');
				controlText.id = 'infoText'
				controlText.style.color = 'rgb(25,25,25)';
				controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
				controlText.style.fontSize = '16px';
				controlText.style.lineHeight = '20px';
				controlText.style.paddingLeft = '5px';
				controlText.style.paddingRight = '5px';
				controlText.innerHTML = last_updated + "<br>" + 'Battery: ' + battery_level + '%<br><br>(253) 486 - 3751';
				controlUI.appendChild(controlText);
		      }
			function GoogleMapsControl(controlDiv, map) {
				var controlUI = document.createElement('div');
				controlUI.style.backgroundColor = '#fff';
				controlUI.style.border = '2px solid #fff';
				controlUI.style.borderRadius = '3px';
				controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
				controlUI.style.cursor = 'pointer';
				controlUI.style.marginBottom = '22px';
				controlUI.style.textAlign = 'center';
				controlUI.title = 'See in Google Maps';
				controlDiv.appendChild(controlUI);

				// Set CSS for the control interior.
				var controlText = document.createElement('div');
				controlText.style.color = 'rgb(25,25,25)';
				controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
				controlText.style.fontSize = '16px';
				controlText.style.lineHeight = '38px';
				controlText.style.paddingLeft = '5px';
				controlText.style.paddingRight = '5px';
				controlText.innerHTML = 'Google Maps';
				controlUI.appendChild(controlText);

				controlUI.addEventListener('click', function() {
				    if (navigator.geolocation) {
				      navigator.geolocation.getCurrentPosition(function(data){
					if (data.coords) {
						var end = new google.maps.LatLng(myLatLng.lat, myLatLng.lng)
					  	window.location = 'https://maps.google.com/maps?saddr=My+Location&daddr=' + end.lat() + ',' + end.lng();
					}
				      });
				    }
				})
				}

			var map;
			var start;
			var directionsDisplay;
			var directionsService;
			var myLatLng = {lat: {{.Latitude}}, lng: {{.Longitude}}};

			function updateLocation() {
				$.ajax({
				    url: "/getLocation",
				    type: "GET",
				    dataType : "json",
				})
				.done(function( json ) {
					myLatLng = { lat: json['latitude'], lng: json['longitude'] };
					informat = 'YYYY-MM-DDTHH:mm:ssZ';
					outformat = 'ddd HH:mmA z';
					last_updated = moment(json['last_updated'], informat).tz('America/Los_Angeles').format(outformat)
					battery_level = json['battery_remaining']
					$('#infoText')[0].innerHTML = last_updated + "<br>" + 'Battery: ' + battery_level + '%<br><br>(253) 486 - 3751'
				})
				.fail(function( xhr, status, errorThrown ) {
				})
				.always(function( xhr, status ) {
				});
			}

			function initMap() {
				directionsDisplay = new google.maps.DirectionsRenderer();
				directionsService = new google.maps.DirectionsService();
				map = new google.maps.Map(document.getElementById('map'), {
					center: myLatLng,
					zoom: 16
				});
				directionsDisplay.setMap(map);

				var marker = new google.maps.Marker({
					position: myLatLng,
					map: map,
					title: 'Zaq?'
				});
				// Create the DIV to hold the control and call the CenterControl()
				// constructor passing in this DIV.
				var infoDiv = document.createElement('div');
				var infoControl = new InfoControl(infoDiv, map, {{.LastUpdated}}, {{.BatteryLevel}});

				var googleMapsDiv = document.createElement('div');
				var googleMapsControl = new GoogleMapsControl(googleMapsDiv, map);

				infoControl.index = 1;
				map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(infoDiv);

				googleMapsControl.index = 1;
				map.controls[google.maps.ControlPosition.TOP_CENTER].push(googleMapsDiv);

				setInterval(updateLocation, 60000);
			}
		</script>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBq0Niyb0Ql8NzTMXWOkBHS7DAIW9xf56Y&callback=initMap"></script>
	</body>
</html>
